const express = require('express'); const cors = require('cors'); const { DynamoDBClient } = require('@aws-sdk/client-dynamodb'); const { DynamoDBDocumentClient, PutCommand, QueryCommand, ScanCommand } = require('@aws-sdk/lib-dynamodb'); const app = express(); const PORT = process.env.PORT || 3000; // Middleware app.use(cors()); app.use(express.json()); // DynamoDB setup for Cyclic const client = new DynamoDBClient({ region: process.env.AWS_REGION || 'us-east-1', credentials: { accessKeyId: process.env.AWS_ACCESS_KEY_ID, secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY } }); const dynamoDB = DynamoDBDocumentClient.from(client); const TABLE_NAME = 'kids-stories-comments'; // Health check endpoint app.get('/', (req, res) => { res.json({ status: 'ok', message: 'Kids Stories API is running!', endpoints: { 'POST /api/comments': 'Submit a new comment', 'GET /api/comments/:storyId': 'Get comments for a specific story', 'GET /api/comments': 'Get all comments' } }); }); // POST: Submit a new comment app.post('/api/comments', async (req, res) => { try { const { storyId, name, rating, comment } = req.body; // Validation if (!storyId || !name || !rating || !comment) { return res.status(400).json({ error: 'Missing required fields: storyId, name, rating, comment' }); } if (rating < 1 || rating > 5) { return res.status(400).json({ error: 'Rating must be between 1 and 5' }); } const timestamp = Date.now(); const commentId = `${storyId}_${timestamp}`; const params = { TableName: TABLE_NAME, Item: { id: commentId, storyId: storyId, name: name.trim(), rating: parseInt(rating), comment: comment.trim(), timestamp: timestamp, date: new Date(timestamp).toISOString() } }; await dynamoDB.send(new PutCommand(params)); res.status(201).json({ success: true, message: 'Comment submitted successfully', commentId: commentId }); } catch (error) { console.error('Error submitting comment:', error); res.status(500).json({ error: 'Failed to submit comment', details: error.message }); } }); // GET: Get comments for a specific story app.get('/api/comments/:storyId', async (req, res) => { try { const { storyId } = req.params; const params = { TableName: TABLE_NAME, FilterExpression: 'storyId = :storyId', ExpressionAttributeValues: { ':storyId': storyId } }; const result = await dynamoDB.send(new ScanCommand(params)); // Sort by timestamp (newest first) const comments = (result.Items || []).sort((a, b) => b.timestamp - a.timestamp); res.json({ success: true, count: comments.length, comments: comments }); } catch (error) { console.error('Error fetching comments:', error); res.status(500).json({ error: 'Failed to fetch comments', details: error.message }); } }); // GET: Get all comments app.get('/api/comments', async (req, res) => { try { const params = { TableName: TABLE_NAME }; const result = await dynamoDB.send(new ScanCommand(params)); // Sort by timestamp (newest first) const comments = (result.Items || []).sort((a, b) => b.timestamp - a.timestamp); res.json({ success: true, count: comments.length, comments: comments }); } catch (error) { console.error('Error fetching all comments:', error); res.status(500).json({ error: 'Failed to fetch comments', details: error.message }); } }); // Start server app.listen(PORT, () => { console.log(`ðŸš€ Server is running on port ${PORT}`); });
