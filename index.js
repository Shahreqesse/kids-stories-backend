const express = require('express'); const cors = require('cors'); const { Pool } = require('pg'); require('dotenv').config(); const app = express(); const PORT = process.env.PORT || 3000; // Middleware app.use(cors()); app.use(express.json()); // PostgreSQL connection const pool = new Pool({ connectionString: process.env.DATABASE_URL, ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false }); // Create table if not exists const initDB = async () => { try { await pool.query(` CREATE TABLE IF NOT EXISTS comments ( id SERIAL PRIMARY KEY, story_id VARCHAR(100) NOT NULL, name VARCHAR(100) NOT NULL, rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5), comment TEXT NOT NULL, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ) `); console.log('âœ… Database initialized'); } catch (error) { console.error('âŒ Database initialization error:', error); } }; initDB(); // Health check endpoint app.get('/', (req, res) => { res.json({ status: 'ok', message: 'Kids Stories API is running on Render!', endpoints: { 'POST /api/comments': 'Submit a new comment', 'GET /api/comments/:storyId': 'Get comments for a specific story', 'GET /api/comments': 'Get all comments', 'GET /api/stats/:storyId': 'Get statistics for a story' } }); }); // POST: Submit a new comment app.post('/api/comments', async (req, res) => { try { const { storyId, name, rating, comment } = req.body; // Validation if (!storyId || !name || !rating || !comment) { return res.status(400).json({ success: false, error: 'ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ: storyId, name, rating, comment' }); } if (rating < 1 || rating > 5) { return res.status(400).json({ success: false, error: 'Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 1 ØªØ§ 5 Ø¨Ø§Ø´Ø¯' }); } const result = await pool.query( 'INSERT INTO comments (story_id, name, rating, comment) VALUES ($1, $2, $3, $4) RETURNING *', [storyId, name.trim(), parseInt(rating), comment.trim()] ); res.status(201).json({ success: true, message: 'Ù†Ø¸Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯', comment: result.rows[0] }); } catch (error) { console.error('Error submitting comment:', error); res.status(500).json({ success: false, error: 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†Ø¸Ø±', details: error.message }); } }); // GET: Get comments for a specific story app.get('/api/comments/:storyId', async (req, res) => { try { const { storyId } = req.params; const result = await pool.query( 'SELECT * FROM comments WHERE story_id = $1 ORDER BY created_at DESC', [storyId] ); res.json({ success: true, count: result.rows.length, comments: result.rows }); } catch (error) { console.error('Error fetching comments:', error); res.status(500).json({ success: false, error: 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†Ø¸Ø±Ø§Øª', details: error.message }); } }); // GET: Get all comments app.get('/api/comments', async (req, res) => { try { const result = await pool.query( 'SELECT * FROM comments ORDER BY created_at DESC' ); res.json({ success: true, count: result.rows.length, comments: result.rows }); } catch (error) { console.error('Error fetching all comments:', error); res.status(500).json({ success: false, error: 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†Ø¸Ø±Ø§Øª', details: error.message }); } }); // GET: Get statistics for a story app.get('/api/stats/:storyId', async (req, res) => { try { const { storyId } = req.params; const result = await pool.query( `SELECT COUNT(*) as total_comments, AVG(rating) as average_rating, COUNT(CASE WHEN rating = 5 THEN 1 END) as five_stars, COUNT(CASE WHEN rating = 4 THEN 1 END) as four_stars, COUNT(CASE WHEN rating = 3 THEN 1 END) as three_stars, COUNT(CASE WHEN rating = 2 THEN 1 END) as two_stars, COUNT(CASE WHEN rating = 1 THEN 1 END) as one_star FROM comments WHERE story_id = $1`, [storyId] ); const stats = result.rows[0]; res.json({ success: true, stats: { totalComments: parseInt(stats.total_comments), averageRating: parseFloat(stats.average_rating) || 0, ratings: { 5: parseInt(stats.five_stars), 4: parseInt(stats.four_stars), 3: parseInt(stats.three_stars), 2: parseInt(stats.two_stars), 1: parseInt(stats.one_star) } } }); } catch (error) { console.error('Error fetching stats:', error); res.status(500).json({ success: false, error: 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø±', details: error.message }); } }); // Start server app.listen(PORT, () => { console.log(`ğŸš€ Server is running on port ${PORT}`); });
    
